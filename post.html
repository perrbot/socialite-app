<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Socialite - Create and post your vibe with camera effects and filters. ðŸ’Žâœ¨ #SocialiteGlowUp" />
  <title>Socialite - Create Post</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" onerror="this.href='';document.body.style.fontFamily='sans-serif';">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" onerror="this.href='';">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #4C51BF, #ED64A6, #9F7AEA); overflow: hidden;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .post-container {
      width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
      position: relative;
    }
    .camera-preview {
      width: 100vw; height: 70vh; max-width: 420px; background: rgba(255,255,255,0.12); border-radius: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
      margin: 0 auto;
    }
    #video { width: 100%; height: 100%; object-fit: cover; border-radius: 30px; }
    #canvas { display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 30px; }
    .controls {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; align-items: center;
    }
    .control-btn {
      background: rgba(255,255,255,0.18); border-radius: 50%; padding: 15px; color: #fff; font-size: 1.5em;
      box-shadow: 0 2px 8px #4C51BF; cursor: pointer; transition: background 0.2s, transform 0.2s;
    }
    .control-btn:hover { background: #ED64A6; transform: scale(1.15); }
    .mode-toggle {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;
    }
    .mode-btn {
      background: rgba(255,255,255,0.18); border-radius: 20px; padding: 10px 15px; color: #fff; font-size: 0.9em; cursor: pointer;
      transition: background 0.2s; border: none;
    }
    .mode-btn.active { background: #ED64A6; }
    .effects {
      position: absolute; top: 20px; left: 10px; display: flex; flex-direction: column; gap: 10px;
    }
    .effect-btn {
      background: rgba(255,255,255,0.18); border-radius: 10px; padding: 10px; color: #fff; font-size: 0.8em; cursor: pointer;
      transition: background 0.2s;
    }
    .effect-btn.active { background: #ED64A6; }
    .editing-tools {
      position: absolute; top: 80px; left: 10px; display: none; flex-direction: column; gap: 10px;
    }
    .edit-btn {
      background: rgba(255,255,255,0.18); border-radius: 10px; padding: 10px; color: #fff; font-size: 0.8em; cursor: pointer;
      transition: background 0.2s;
    }
    .edit-btn.active { background: #ED64A6; }
    .text-overlay {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 2em; font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7); display: none; cursor: move;
    }
    .music-selector {
      position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 350px;
      background: rgba(255,255,255,0.18); border-radius: 20px; padding: 10px; display: none;
    }
    .music-option {
      background: rgba(255,255,255,0.1); border-radius: 10px; padding: 8px; margin: 5px 0; color: #fff; cursor: pointer;
      transition: background 0.2s;
    }
    .music-option.active { background: #ED64A6; }
    .text-input {
      position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 350px;
      background: rgba(255,255,255,0.18); border-radius: 20px; padding: 10px; color: #fff; font-size: 1em; border: none;
      outline: none; resize: none; min-height: 40px;
    }
    .text-input::placeholder { color: rgba(255,255,255,0.7); }
    .post-btn {
      position: absolute; bottom: 20px; right: 20px; background: linear-gradient(45deg, #ED64A6, #4C51BF); color: #fff;
      border: none; border-radius: 50%; padding: 15px; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 15px rgba(237,100,166,0.5);
      transition: transform 0.2s;
    }
    .post-btn:hover { transform: scale(1.1); }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #FFF; font-size: 2em; display: none; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }
    body.dark-mode { background: linear-gradient(135deg, #2D3748, #4A5568, #718096); }
    body.dark-mode .camera-preview { background: rgba(45, 55, 72, 0.2); }
  </style>
</head>
<body>
  <div class="post-container">
    <div class="camera-preview">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="mode-toggle">
        <button class="mode-btn active" id="photo-mode">Photo</button>
        <button class="mode-btn" id="video-mode">Video</button>
      </div>
      <div class="effects">
        <button class="effect-btn" data-filter="none">None</button>
        <button class="effect-btn" data-filter="sepia">Sepia</button>
        <button class="effect-btn" data-filter="grayscale">B&W</button>
        <button class="effect-btn" data-filter="blur">Blur</button>
        <button class="effect-btn" data-filter="brightness">Bright</button>
        <button class="effect-btn" data-filter="contrast">Contrast</button>
        <button class="effect-btn" data-filter="hue-rotate">Hue</button>
        <button class="effect-btn" data-filter="invert">Invert</button>
        <button class="effect-btn" data-filter="saturate">Saturate</button>
      </div>
      <div class="editing-tools">
        <button class="edit-btn" id="add-text-btn">Add Text</button>
        <button class="edit-btn" id="add-music-btn">Add Music</button>
      </div>
      <div class="text-overlay" id="text-overlay" contenteditable="true">Your Text Here</div>
      <div class="music-selector" id="music-selector">
        <div class="music-option" data-music="none">No Music</div>
        <div class="music-option" data-music="upbeat">Upbeat Pop</div>
        <div class="music-option" data-music="chill">Chill Vibes</div>
        <div class="music-option" data-music="hiphop">Hip Hop</div>
        <div class="music-option" data-music="electronic">Electronic</div>
      </div>
      <textarea class="text-input" placeholder="Add a caption..." id="caption"></textarea>
      <div class="controls">
        <button class="control-btn" id="capture-btn" aria-label="Capture photo"><i class="fas fa-camera"></i></button>
        <button class="control-btn" id="switch-camera-btn" aria-label="Switch camera"><i class="fas fa-sync-alt"></i></button>
      </div>
      <button class="post-btn" id="post-btn" aria-label="Post content"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="loading" id="loading">Posting...</div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" async></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js" async></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js" async></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js" async></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDdfcTtRD-HdvB_n_colrUWQI-FUZAiNh0",
      authDomain: "socialite-bae96.firebaseapp.com",
      projectId: "socialite-bae96",
      storageBucket: "socialite-bae96.firebasestorage.app",
      messagingSenderId: "871563265567",
      appId: "1:871563265567:web:60b88ac1688f8af3ae372a",
      measurementId: "G-5LN8406TPX"
    };

    let app, auth, analytics, storage;
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let currentStream;
    let currentFilter = 'none';
    let capturedImage = null;
    let currentMode = 'photo';
    let isRecording = false;
    let recordedVideo = null;
    let selectedMusic = 'none';
    let mediaRecorder;
    let recordedChunks = [];

    document.getElementById('loading').style.display = 'block';
    setTimeout(async () => {
      try {
        if (!window.firebaseApp) {
          app = firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          analytics = firebase.analytics(app);
          storage = firebase.storage();
          window.firebaseApp = app;
        } else {
          app = window.firebaseApp;
          auth = firebase.auth();
          analytics = firebase.analytics(app);
          storage = firebase.storage();
        }
        document.getElementById('loading').style.display = 'none';

        auth.onAuthStateChanged(async (user) => {
          if (!user) return window.location.replace('login.html');
          await startCamera();
        });
      } catch (e) {
        console.error("Firebase initialization failed:", e);
        document.getElementById('loading').textContent = 'Retry in progress...';
        setTimeout(() => location.reload(), 2000);
      }
    }, 1000);

    async function startCamera(facingMode = 'user') {
      try {
        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
        const constraints = { video: { facingMode }, audio: currentMode === 'video' };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
      } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Camera access denied or unavailable.');
      }
    }

    document.getElementById('switch-camera-btn').addEventListener('click', () => {
      const facingMode = video.srcObject.getVideoTracks()[0].getSettings().facingMode === 'user' ? 'environment' : 'user';
      startCamera(facingMode);
    });

    // Mode switching
    document.getElementById('photo-mode').addEventListener('click', () => {
      currentMode = 'photo';
      document.getElementById('photo-mode').classList.add('active');
      document.getElementById('video-mode').classList.remove('active');
      document.getElementById('capture-btn').innerHTML = '<i class="fas fa-camera"></i>';
      document.getElementById('capture-btn').setAttribute('aria-label', 'Capture photo');
      document.querySelector('.editing-tools').style.display = 'none';
      startCamera();
    });

    document.getElementById('video-mode').addEventListener('click', () => {
      currentMode = 'video';
      document.getElementById('video-mode').classList.add('active');
      document.getElementById('photo-mode').classList.remove('active');
      document.getElementById('capture-btn').innerHTML = '<i class="fas fa-video"></i>';
      document.getElementById('capture-btn').setAttribute('aria-label', 'Record video');
      document.querySelector('.editing-tools').style.display = 'flex';
      startCamera();
    });

    // Capture/Record functionality
    document.getElementById('capture-btn').addEventListener('click', () => {
      if (currentMode === 'photo') {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.filter = getFilterCSS(currentFilter);
        ctx.drawImage(video, 0, 0);
        capturedImage = canvas.toDataURL('image/jpeg');
        video.style.display = 'none';
        canvas.style.display = 'block';
      } else {
        if (!isRecording) {
          startRecording();
        } else {
          stopRecording();
        }
      }
    });

    function startRecording() {
      recordedChunks = [];
      const options = { mimeType: 'video/webm;codecs=vp9' };
      mediaRecorder = new MediaRecorder(currentStream, options);
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) recordedChunks.push(event.data);
      };
      mediaRecorder.onstop = () => {
        recordedVideo = new Blob(recordedChunks, { type: 'video/webm' });
        const videoURL = URL.createObjectURL(recordedVideo);
        video.srcObject = null;
        video.src = videoURL;
        video.style.display = 'block';
        canvas.style.display = 'none';
      };
      mediaRecorder.start();
      isRecording = true;
      document.getElementById('recording-indicator').style.display = 'block';
      document.getElementById('capture-btn').innerHTML = '<i class="fas fa-stop"></i>';
    }

    function stopRecording() {
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById('recording-indicator').style.display = 'none';
      document.getElementById('capture-btn').innerHTML = '<i class="fas fa-video"></i>';
    }

    document.querySelectorAll('.effect-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.effect-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        if (capturedImage) {
          ctx.filter = getFilterCSS(currentFilter);
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
          };
          img.src = capturedImage;
        }
      });
    });

    function getFilterCSS(filter) {
      switch (filter) {
        case 'sepia': return 'sepia(100%)';
        case 'grayscale': return 'grayscale(100%)';
        case 'blur': return 'blur(5px)';
        case 'brightness': return 'brightness(150%)';
        case 'contrast': return 'contrast(150%)';
        case 'hue-rotate': return 'hue-rotate(90deg)';
        case 'invert': return 'invert(100%)';
        case 'saturate': return 'saturate(200%)';
        default: return 'none';
      }
    }

    // Text overlay
    document.getElementById('add-text-btn').addEventListener('click', () => {
      document.getElementById('text-overlay').style.display = 'block';
    });

    // Make text overlay draggable
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };

    document.getElementById('text-overlay').addEventListener('mousedown', (e) => {
      isDragging = true;
      const rect = e.target.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const overlay = document.getElementById('text-overlay');
        overlay.style.left = e.clientX - dragOffset.x + 'px';
        overlay.style.top = e.clientY - dragOffset.y + 'px';
        overlay.style.transform = 'none';
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Music selector
    document.getElementById('add-music-btn').addEventListener('click', () => {
      document.getElementById('music-selector').style.display = 'block';
    });

    document.querySelectorAll('.music-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.music-option').forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        selectedMusic = option.dataset.music;
      });
    });

    // Update post button functionality
    document.getElementById('post-btn').addEventListener('click', async () => {
      if (currentMode === 'photo' && !capturedImage) return alert('Please capture an image first.');
      if (currentMode === 'video' && !recordedVideo) return alert('Please record a video first.');
      const caption = document.getElementById('caption').value.trim();
      document.getElementById('loading').style.display = 'block';

      try {
        const user = auth.currentUser;
        const token = await user.getIdToken();

        let downloadURL;
        let mediaType;

        if (currentMode === 'photo') {
          // Upload image to Firebase Storage
          const storageRef = storage.ref();
          const imageRef = storageRef.child(`posts/${user.uid}/${Date.now()}.jpg`);
          const response = await fetch(capturedImage);
          const blob = await response.blob();
          await imageRef.put(blob);
          downloadURL = await imageRef.getDownloadURL();
          mediaType = 'image';
        } else {
          // Upload video to Firebase Storage
          const storageRef = storage.ref();
          const videoRef = storageRef.child(`posts/${user.uid}/${Date.now()}.webm`);
          await videoRef.put(recordedVideo);
          downloadURL = await videoRef.getDownloadURL();
          mediaType = 'video';
        }

        // Post to backend
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            content: caption,
            mediaUrl: downloadURL,
            mediaType: mediaType,
            music: selectedMusic
          })
        });

        if (!res.ok) throw new Error('Failed to post');

        try { analytics.logEvent('post_created'); } catch (err) {}

        // Redirect to Home.html
        window.location.replace('Home.html');
      } catch (err) {
        console.error('Posting failed:', err);
        alert('Failed to post. Please try again.');
        document.getElementById('loading').style.display = 'none';
      }
    });

    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
  </script>
</body>
</html>
